<!doctype html>
<html class="no-js">
  <head>
    <title>Mailman mit GMail - Webhippie United</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Mailman mit GMail - Webhippie United" />
    <meta name="keywords" content=", " />
    <meta property="og:title" content="Mailman mit GMail"/>
    <meta property="og:site_name" content=" - Webhippie United"/>
    <meta property="og:url" content=" - http://nerd.local:4000"/>
    <meta property="og:description" content=""/>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Mailman mit GMail">
    <meta name="twitter:description" content="">
  
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="http://nerd.local:4000/css/app.css" />
    <link rel="stylesheet" href="http://nerd.local:4000/css/pygments.css" />
    <link rel="shortcut icon" href="favicon.ico">

    <script src="bower_components/modernizr/modernizr.js"></script>
  </head>
  <body>

    <header>
  <div class="row">
    <div class="small-12 columns text-center">
      <div class="logo-container">
        <a href="http://nerd.local:4000">
          <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 93 101" preserveAspectRatio="xMinyMin meet">
	<g>
		<path d="M33.522,54.16c0-5.891-3.078-12.046-9.452-12.046c-6.331,0-9.496,5.847-9.496,12.354c0,6.33,3.429,12.002,9.452,12.002
			C30.092,66.47,33.522,60.886,33.522,54.16"/>
		<path d="M42.143,98.083l-2.77,0.264c0.968-2.594,2.155-7.297,2.639-10.507l4.308-0.44C45.308,91.137,43.374,96.017,42.143,98.083
			 M32.912,97.82l-2.419,0.308c0.923-2.594,2.111-7.167,2.551-10.288l4-0.44C36.033,91.093,34.143,95.798,32.912,97.82
			 M92.639,18.596v-2.242c-4.742,0-5.41-1.715-5.41-3.253c0-1.231,0.267-2.462,0.533-3.693c0.268-1.231,0.535-2.418,0.535-3.649
			C88.297,1.714,84.223,0,78.546,0H77.21v2.417h1.202c3.875,0.045,5.277,1.408,5.277,3.782c0,1.011-0.267,2.066-0.467,3.121
			c-0.268,1.099-0.535,2.154-0.535,3.341c0,2.813,1.87,4.221,4.809,4.748v0.088c-2.939,0.483-4.809,1.978-4.809,4.792
			c0,1.187,0.267,2.286,0.535,3.341c0.2,1.099,0.467,2.11,0.467,3.166c0,2.461-1.603,3.78-5.344,3.824h-0.533v-0.026H12.431v0.026
			h-0.407c-3.162,0-4.46-1.363-4.46-3.824c0-1.056,0.17-2.067,0.395-3.166c0.227-1.055,0.395-2.154,0.395-3.341
			c0.057-2.814-1.524-4.309-4.064-4.792v-0.088c2.54-0.527,4.121-1.935,4.064-4.748c0-1.187-0.168-2.242-0.395-3.341
			C7.734,8.265,7.564,7.21,7.564,6.199c0-2.374,1.129-3.782,4.46-3.782h1.015V0h-1.185C7.056,0,3.669,1.714,3.669,5.759
			c0,1.231,0.226,2.418,0.452,3.649c0.226,1.231,0.452,2.462,0.452,3.693c0,1.538-0.565,3.253-4.573,3.253v2.242
			c4.008,0,4.573,1.89,4.573,3.254c0,1.187-0.226,2.373-0.452,3.56c-0.226,1.187-0.452,2.418-0.452,3.605
			c0,4.441,3.5,6.023,8.185,6.023h0.577v11.038c2.351-4.451,6.641-7.083,11.814-7.083c8.09,0,13.321,6.199,13.321,14.991
			c0,10.199-6.198,15.607-13.76,15.607c-5.042,0-9.114-2.521-11.375-6.711v38.147h65.381V75.484c-2.484,1.349-5.335,2.04-8.361,2.04
			c-9.854,0-16.774-7.639-16.774-18.933c0-11.847,7.363-19.598,17.327-19.598c2.924,0,5.549,0.645,7.808,1.824v-5.779h0.801
			c5.476,0,9.684-1.582,9.684-6.023c0-1.187-0.267-2.418-0.535-3.605c-0.266-1.187-0.533-2.373-0.533-3.56
			C87.229,20.486,87.897,18.596,92.639,18.596"/>
		<path d="M69.783,42.923c-7.972,0-11.958,7.363-11.958,15.557c0,7.972,4.318,15.113,11.903,15.113c3.369,0,6.092-1.369,8.084-3.625
			V46.534C75.877,44.338,73.209,42.923,69.783,42.923"/>
	</g>
</svg>

        </a>
      </div>
    </div>
    <div class="small-12 columns">
      <div class="title">
        <a href="http://nerd.local:4000">
          Webhippie United
        </a>
      </div>
      <div class="subtitle">
        Software- und Web-Entwicklung
      </div>
    </div>
  </div>
</header>
    <div class="row">
      <div class="small-12 spaced-top spaced-bottom columns">
        <div class="site-title">
          Blog
        </div>
      </div>
    </div>

    <div class="row">
      <div class="small-12 columns">
        <div class="blog-post">
          <h1>Mailman mit GMail</h1>
          <div class="post-info">
            19.07.2013 / Danyel
          </div>
          <div class="post-content spaced-top spaced-bottom">
            <p>Um Mailman mit GMail aufsetzen zu können, muss man einige Tricks verwenden.<br />
Anfangs hat es nicht so geklappt, wie es sollte, darum habe ich mich entschieden, diesen Post zu verfassen.</p>

<p>Das Standard Prozedere werde ich erst verfassen,
wenn ihr direkt zum GMail-Teil springen wollt, scrollt runter.</p>

<h1 id="mailman-aufsetzen">Mailman aufsetzen</h1>
<p><em>Mailman</em> läuft standardmäßig in einem <strong>eigenen Prozess</strong>,
die Datei sollte deshalb ein ausführbares Skript sein,
das mit einem Shebang beginnt.
Wenn man <em>Mailman</em> <strong>parallel</strong> zu einer <strong>Rails-Umgebung</strong> laufen lassen will,
um Zugang zu <em>ActiveRecord</em> etc. zu haben, dann kann man das tun,
man braucht jedoch zwei zusätzliche <strong>require</strong> Anweisungen.<br />
So würde beispielsweise unsere Datei aussehen,
wenn wir eine Nachricht von der <strong>Standardeingabe</strong> lesen
und an die Standardausgabe feuern wolltet:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1">#!/usr/bin/env ruby</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="lineno"> 4</span> <span class="nb">require</span> <span class="s1">&#39;bundler/setup&#39;</span>
<span class="lineno"> 5</span> <span class="nb">require</span> <span class="s1">&#39;mailman&#39;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="no">Mailman</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
<span class="lineno"> 8</span>   <span class="n">default</span> <span class="k">do</span>
<span class="lineno"> 9</span>     <span class="nb">puts</span> <span class="s2">&quot;I have received a message from </span><span class="si">#{</span><span class="n">message</span><span class="o">[</span><span class="ss">:from</span><span class="o">].</span><span class="n">display_names</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">!&quot;</span>
<span class="lineno">10</span>     <span class="nb">puts</span> <span class="s2">&quot;Subject: </span><span class="si">#{</span><span class="n">message</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">11</span>     <span class="nb">puts</span> <span class="s2">&quot;**************************&quot;</span>
<span class="lineno">12</span>     <span class="nb">puts</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span>
<span class="lineno">13</span>     <span class="nb">puts</span> <span class="s2">&quot;**************************&quot;</span>
<span class="lineno">14</span>   <span class="k">end</span>
<span class="lineno">15</span> <span class="k">end</span>
</code></pre></div>

<p><em>Zeilen 3-4</em> sind nur notwendig, wenn man das Skript von einem Rails-Verzeichnis aufruft.</p>

<p>Zu <em>Zeile 8</em> können wir sogenannte Routen definieren,
die alle verschiedenen Formen annehmen können.
Meistens werden dort je nach Absender oder Betreff verschiedene Aktionen unternommen.
Für genauere Informationen lest
<a href="https://github.com/titanous/mailman/blob/master/USER_GUIDE.md#routes">hier</a> nach.</p>

<p>Zu <em>Zeile 9</em> haben wir Zugriff auf das <strong>message</strong> Objekt,
dies ist eine Instanz der <code style="display: inline;">Mail::Message</code>-Klasse,
eine ausführliche Dokumentation findet ihr <a href="http://rdoc.info/github/mikel/mail/Mail/Message">hier</a>.</p>

<h1 id="mailman-mit-gmail-aufsetzen">Mailman mit GMail aufsetzen</h1>

<p>Um <em>Mailman</em> mit <em>GMail</em> zu nutzen, müssen wir zunächst <em>Mailman</em> sagen,
von welchem Postfach er pollen soll. Ich benutze als Protokoll
<strong>IMAP</strong>, da es flexibler ist. Ihr könnt natürlich auch <strong>POP3</strong> verwenden,
<em>GMail</em> unterscheidet bei den Ports, soweit ich weiß, nicht.</p>

<p>Auf jeden Fall können wir das in Mailman folgendermaßen konfigurieren:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">Mailman</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">imap</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">username</span><span class="p">:</span> <span class="s1">&#39;username@gmail.com&#39;</span><span class="p">,</span>
  <span class="ss">password</span><span class="p">:</span> <span class="s1">&#39;geheimes_passwort&#39;</span><span class="p">,</span>
  <span class="ss">server</span><span class="p">:</span> <span class="s1">&#39;imap.gmail.com&#39;</span><span class="p">,</span>
  <span class="ss">port</span><span class="p">:</span> <span class="mi">993</span><span class="p">,</span>
  <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
  <span class="c1"># filter: &#39;SEEN&#39;</span>
  <span class="c1"># done_flags: [Net::IMAP::DELETED]</span>
<span class="p">}</span>
</code></pre></div>

<p>Für zusätzliche Optionen könnt ihr 
<a href="https://github.com/titanous/mailman/blob/master/lib/mailman/receiver/imap.rb">hier</a> nachschauen,
was ich jedoch noch anmerken will, ist: Um den Nachrichtenempfang zu debuggen,
kann es verdrießlich sein, ständig neue E-Mails zu senden.
Deshalb kann es manchmal nützlich sein, die <em>filter</em>-Option auf <em>‘SEEN’</em> zu setzen,
wie auskommentiert gezeigt. Bei sehr vielen gelesenen Mails kann das aber schnell nervig werden.
Um Nachrichten beim Empfang zu löschen, muss das IMAP-Flag gesetzt werden (erneut, wie auskommentiert gezeigt).</p>

<h2 id="nachricht-von-gmail-holen">Nachricht von GMail holen</h2>

<p>Jetzt kommen wir zum eigentlichen Teil:<br />
Eine Nachricht von <em>GMail</em> kommt in mehreren Teilen:
Standardmäßig mit Content-type <em>text/plain</em> und <em>text/html</em>,
um hier die richtige rauszusuchen (bei uns: <em>text/plain</em>),
machen wir folgendes:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">msg</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">find</span><span class="p">{</span><span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">start_with?</span> <span class="s2">&quot;text/plain&quot;</span> <span class="p">}</span>
</code></pre></div>

<p>Das Problem ist jetzt noch,
dass der <strong>decoded</strong> body von <em>Mail</em> nicht richtig encoded wird.
Mit zwei Zeilen ist das aber auch getan:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span>
<span class="n">body</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
</code></pre></div>

<p>Am Ende sieht unser Programm also ungefähr so aus:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1">#!/usr/bin/env ruby</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c1"># require &quot;rubygems&quot; # nur zu Rails</span>
<span class="lineno"> 4</span> <span class="c1"># require &quot;bundler/setup&quot; # nur zu Rails</span>
<span class="lineno"> 5</span> <span class="nb">require</span> <span class="s1">&#39;mailman&#39;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="no">Mailman</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rails_root</span> <span class="o">=</span> <span class="kp">nil</span> <span class="c1"># default: &quot;.&quot;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="no">Mailman</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">imap</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">10</span>   <span class="ss">username</span><span class="p">:</span> <span class="s1">&#39;superman@gmail.com&#39;</span><span class="p">,</span>
<span class="lineno">11</span>   <span class="ss">password</span><span class="p">:</span> <span class="s1">&#39;clark kent&#39;</span><span class="p">,</span>
<span class="lineno">12</span>   <span class="ss">server</span><span class="p">:</span> <span class="s1">&#39;imap.gmail.com&#39;</span><span class="p">,</span>
<span class="lineno">13</span>   <span class="ss">port</span><span class="p">:</span> <span class="mi">993</span><span class="p">,</span>
<span class="lineno">14</span>   <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
<span class="lineno">15</span> <span class="p">}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="no">Mailman</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
<span class="lineno">18</span>   <span class="n">default</span> <span class="k">do</span>
<span class="lineno">19</span>     <span class="n">msg</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">find</span><span class="p">{</span><span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">start_with?</span> <span class="s2">&quot;text/plain&quot;</span> <span class="p">}</span>
<span class="lineno">20</span>     <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span>
<span class="lineno">21</span>     <span class="n">body</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="c1"># body können wir nun nach Lust und Laune verwenden.</span>
<span class="lineno">24</span>     <span class="c1"># Zu Rails können wir beispielsweise sowas machen:</span>
<span class="lineno">25</span>     <span class="c1"># Message.create! from: message.from, subject: message.subject, body: body</span>
<span class="lineno">26</span>   <span class="k">end</span>
<span class="lineno">27</span> <span class="k">end</span>
</code></pre></div>

<p>Ich hoffe, dieser Post war hilfreich. Bei Fragen wendet euch an <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#100;&#097;&#110;&#121;&#101;&#108;&#064;&#119;&#101;&#098;&#104;&#105;&#112;&#112;&#105;&#101;&#046;&#100;&#101;">mich</a></p>

<p>Liebe Grüße,<br />
Danyel.</p>

          </div>      
          <div class="post-tags">
            <span class="tags-label">Tags:</span>
            <div class="tags-list">
              
                <a href="/tag/mailman">mailman</a>&nbsp;/ 
              
                <a href="/tag/gmail">gmail</a>&nbsp;/ 
              
                <a href="/tag/ruby">ruby</a>&nbsp;/ 
              
                <a href="/tag/gems">gems</a>&nbsp;/ 
              
                <a href="/tag/imap">imap</a>&nbsp;/ 
              
            </div>
          </div>
        </div>
      </div>
    </div>
    

    <footer>
  <div class="row">
    <div class="small-12 columns text-center">
      &copy; 2014 Webhippie Team | <a href="http://nerd.local:4000/imprint.html">Impressum</a>
    </div>
  </div>
</footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://nerd.local:4000/bower_components/jquery/jquery.js"><\/script>')</script>
    <script src="http://nerd.local:4000/js/plugins.js"></script>
    <script src="http://nerd.local:4000/bower_components/foundation/js/foundation.min.js"></script>
    <script src="http://nerd.local:4000/js/jquery.fittext.js"></script>
    <script src="http://nerd.local:4000/js/app.js"></script>
  </body>
</html>